<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Listas de la compra - NutriCelia</title>
    <link rel="stylesheet" href="../css/userstyles.css">

    <!-- Vue.js y Axios -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>

<header>
    <div class="logo">
        <img src="../images/NutriCelia.png">
    </div>
    <nav>
        <a href="HomePage.html">Inicio</a>
        <a href="#">Productos</a>
        <a href="ShoppingListListingPageV2.html">Mis Listas</a>
        <a href="ReceipeListScreen.html">Recetas</a>
        <a href="ForumScreen.html">Foros</a>
    </nav>
    <div class="user-profile">
        <img class="menu" src="../images/menu-icon.png">
        <a href="UserDataScreen.html">
            <button class="user-profile"><img src="../images/icon-user.png"></button>
        </a>
    </div>
</header>

<h1>Listas de la compra</h1>

<main>
    <form id="createBuyList">
        <input v-model="nombre" id="nombre" name="nombre" type="text" placeholder="Nombre de la nueva lista">
        <button type="submit"  class="btn">Crear Lista</button>
    </form>

    <!-- Contenedor donde se mostrarán las listas de compra -->
    <h2>Mis Listas de Compra</h2>
    <div id="buyListsContainer">
        <p>Cargando listas...</p> <!-- Mensaje inicial mientras se cargan los datos -->
    </div>
</main>

<!--
<main id="app">
    <form @submit.prevent="createBuyList">
        <input v-model="nombre" type="text" placeholder="Nombre de la nueva lista">
        <button type="submit" class="btn">Crear Lista</button>
    </form>

    <section v-for="list in buyLists" :key="list.id" class="user-data" @click="goToProducts(list.id)">
        <input v-if="editingId === list.id" v-model="editedName">
        <p v-else><strong>{{ list.nombre }}</strong></p>

        <button v-if="editingId !== list.id" @click="startEditing(list)" class="btn">Editar</button>
        <button v-if="editingId === list.id" @click="saveEdit(list.id)" class="btn">Guardar</button>
        <button @click="deleteBuyList(list.id)" class="btn">Eliminar</button>
    </section>
</main>
-->
<script>
    var userEmail = null;
    var userName = null;
    loadUserData();

    document.getElementById("createBuyList").addEventListener("submit", async function(event) {
        event.preventDefault(); // Evita el envío tradicional del formulario

        const buyListName = document.getElementById("nombre").value;
        const buyListData = { nombre: buyListName};

        try {
            const responseBuyList = await fetch("http://localhost:8080/buyListResource", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(buyListData)
            });

            //Parte de responseUsrAccList

            const createdBuyList = await responseBuyList.json();
            const buyListId = createdBuyList.id; // Extraer el ID de la lista creada

            // Crear la relación UsersWithAccessToList
            const usersWithAccessData = {
                usersWithAccessToListId: {
                    email: userEmail,
                    id_lista: buyListId
                },
                propietario: true // El usuario que crea la lista es el propietario
            };

            const responseUsrAccList = await fetch("http://localhost:8080/usersWithAccesToList", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(usersWithAccessData)
            });

            if (responseBuyList.ok && responseUsrAccList.ok) {
                window.location.reload(); // Refrescar a la página
                alert("Funciona. En teoria");
            } else {
                alert("Error al crear la lista. Verifica el nombre.");
            }

        } catch (error) {
            console.error("Error la pagina de listas:", error);
            alert("Error al conectar con el servidor.");
        }

    });

    async function loadUserData() {
        try {
            console.log(localStorage.getItem("token"));

            const token = localStorage.getItem("token");
            if (!token) {
                alert("No se encontró el token de autenticación.");
                return;
            }

            const response = await fetch("http://localhost:8080/user/me", {
                method: "GET",
                headers: {
                    "Authorization": "Bearer " + token,
                    "Content-Type": "application/json"
                }
            });

            if (response.ok) {
                const user = await response.json();
                userName = user.nombre;
                userEmail  = user.email;

                fetchUserBuyLists();
            } else {
                const errorData = await response.json();
                alert("Error al cargar los datos del usuario: " + (errorData.message || "Error desconocido"));
            }
        } catch (error) {
            console.error("Error al obtener los datos:", error);
            alert("Hubo un error al intentar obtener los datos del usuario.");
        }
    }


    async function fetchUserBuyLists() {
        if (!userEmail) {
            alert("Email del usuario no disponible, intentando de nuevo...");
            return;
        }

        try {
            // Obtener todas las listas de compra
            const listsResponse = await fetch("http://localhost:8080/buyListResource");
            if (!listsResponse.ok) throw new Error("Error al obtener las listas de compra.");
            const allLists = await listsResponse.json();

            // Consultar listas a las que el usuario tiene acceso
            const accessResponse = await fetch(`http://localhost:8080/usersWithAccesToList/${encodeURIComponent(userEmail)}`);
            if (!accessResponse.ok) throw new Error("Error al obtener listas del usuario.");
            const userAccessLists = await accessResponse.json();

            // Extraer IDs de listas permitidas
            const accessibleListIds = new Set(userAccessLists.map(entry => entry.id_lista));

            // Filtrar listas accesibles para el usuario
            const userLists = allLists.filter(list => accessibleListIds.has(list.id));

            // Mostrar listas en la página
            const container = document.getElementById("buyListsContainer");
            container.innerHTML = userLists.length ? "" : "<p>No tienes listas disponibles.</p>";

            userLists.forEach(list => {
                const listElement = document.createElement("div");
                listElement.classList.add("user-data");
                listElement.innerHTML = `
                    <p><strong>${list.nombre}</strong></p>
                    <button onclick="deleteBuyList(${list.id})" class="btn">Eliminar</button>
                `;
                container.appendChild(listElement);
            });

        } catch (error) {
            console.error("Error obteniendo listas del usuario:", error);
            alert("No se pudieron cargar tus listas de compra.");
        }
    }

    /*
    document.addEventListener("DOMContentLoaded", fetchBuyLists);

    async function fetchBuyLists() {
        try {
            const response = await fetch("http://localhost:8080/buyListResource");
            if (!response.ok) throw new Error("Error obteniendo las listas");

            const buyLists = await response.json();
            const container = document.getElementById("buyListsContainer");
            container.innerHTML = ""; // Limpiar antes de agregar

            buyLists.forEach(list => {
                const listElement = document.createElement("section");
                listElement.classList.add("user-data");
                listElement.setAttribute("onclick", `goToProducts(${list.id})`);

                listElement.innerHTML = `
                    <p><strong>${list.nombre}</strong></p>
                    <button class="btn" onclick="event.stopPropagation(); deleteBuyList(${list.id})">Eliminar</button>
                `;

                container.appendChild(listElement);
            });
        } catch (error) {
            console.error("Error obteniendo listas:", error);
        }
    }

    function goToProducts(id) {
        window.location.href = `ShoppingListScreen.html?id_lista=${id}`;
    }

    async function deleteBuyList(id) {
        if (!confirm("¿Seguro que deseas eliminar esta lista?")) return;

        try {
            const response = await fetch(`http://localhost:8080/buyListResource/${id}`, { method: "DELETE" });

            if (response.ok) {
                fetchBuyLists(); // Recargar listas tras eliminación
            } else {
                alert("No se pudo eliminar la lista.");
            }
        } catch (error) {
            console.error("Error eliminando lista:", error);
            alert("Error de conexión con el servidor.");
        }
    }
    */
</script>
</body>
</html>
